name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - develop
      - main

env:
  NODE_VERSION: '18'

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Claude Flow
        run: npm install -g claude-flow@alpha

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Run Code Review Swarm
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„Çí„É™„Çπ„Éà„Å´‰øùÂ≠ò
          echo "${{ steps.changed-files.outputs.all_changed_files }}" > /tmp/changed_files.txt
          
          # code-review-swarm„ÇíÂÆüË°å
          npx claude-flow@alpha swarm "Review the following code changes for bugs, security issues, performance problems, and code quality. Changed files: $(cat /tmp/changed_files.txt)" \
            --agents "security-auditor,performance-analyst,code-reviewer,tester" \
            --strategy parallel \
            --output-format json \
            --output-file /tmp/review_result.json \
            --non-interactive

      - name: Parse Review Results
        id: parse-review
        run: |
          # „É¨„Éì„É•„ÉºÁµêÊûú„ÇíMarkdown„Å´Â§âÊèõ
          node << 'EOF' > /tmp/review_comment.md
          const fs = require('fs');
          
          let review;
          try {
            review = JSON.parse(fs.readFileSync('/tmp/review_result.json', 'utf8'));
          } catch (e) {
            console.log('## ü§ñ AI Code Review\n\n‚ö†Ô∏è Review completed but results could not be parsed.\n\nPlease review manually.');
            process.exit(0);
          }
          
          let markdown = '## ü§ñ AI Code Review\n\n';
          
          const errors = review.results?.errors || [];
          const insights = review.results?.insights || [];
          const warnings = review.results?.warnings || [];
          
          if (errors.length > 0) {
            markdown += '### ‚ùå Issues Found\n\n';
            errors.forEach(error => markdown += `- ${error}\n`);
            markdown += '\n';
          }
          
          if (warnings.length > 0) {
            markdown += '### ‚ö†Ô∏è Warnings\n\n';
            warnings.forEach(warning => markdown += `- ${warning}\n`);
            markdown += '\n';
          }
          
          if (insights.length > 0) {
            markdown += '### üí° Suggestions\n\n';
            insights.forEach(insight => markdown += `- ${insight}\n`);
            markdown += '\n';
          }
          
          if (errors.length === 0 && warnings.length === 0) {
            markdown += '### ‚úÖ No Critical Issues Found\n\n';
            markdown += 'The code changes look good! Minor suggestions may be listed above.\n\n';
          }
          
          markdown += '---\n*Powered by [Claude Flow](https://github.com/ruvnet/claude-flow)*';
          
          console.log(markdown);
          EOF

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment;
            try {
              comment = fs.readFileSync('/tmp/review_comment.md', 'utf8');
            } catch (e) {
              comment = '## ü§ñ AI Code Review\n\n‚úÖ Review completed. No critical issues found.';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
