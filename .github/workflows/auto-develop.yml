name: Auto Develop from Issue

on:
  issues:
    types: [labeled]

env:
  NODE_VERSION: '18'

jobs:
  develop:
    # auto-develop„É©„Éô„É´„Åå‰ªò‰∏é„Åï„Çå„ÅüÂ†¥Âêà„Å´„ÅÆ„ÅøÂÆüË°å
    if: github.event.label.name == 'auto-develop'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Claude Flow
        run: npm install -g claude-flow@alpha

      - name: Create feature branch
        run: |
          BRANCH_NAME="feature/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Claude Flow Swarm
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # IssueÂÜÖÂÆπ„Çí„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
          cat << 'EOF' > /tmp/issue_content.md
          # ${{ github.event.issue.title }}
          
          ${{ github.event.issue.body }}
          EOF
          
          # claude-flow swarm„ÇíÂÆüË°å
          npx claude-flow@alpha swarm "Implement the following task based on the issue content. Read the design documents in docs/design/ and docs/specs/ for context. Follow TDD principles. Issue: $(cat /tmp/issue_content.md)" \
            --agents "planner,architect,coder,tester,reviewer" \
            --strategy parallel \
            --output-format json \
            --output-file /tmp/swarm_result.json \
            --non-interactive

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "feat: implement issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"

      - name: Push branch
        run: |
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          base: develop
          title: "feat: ${{ github.event.issue.title }}"
          body: |
            ## Summary
            
            This PR was automatically generated by Claude Flow to implement Issue #${{ github.event.issue.number }}.
            
            ## Related Issue
            
            Closes #${{ github.event.issue.number }}
            
            ## Changes
            
            - Implemented the feature/fix as described in the issue
            - Added tests following TDD principles
            
            ## Checklist
            
            - [ ] Code follows project conventions
            - [ ] Tests pass locally
            - [ ] Documentation updated if needed
            
            ---
            *This PR was auto-generated by [Claude Flow](https://github.com/ruvnet/claude-flow)*
          labels: |
            auto-generated
            needs-review

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ü§ñ **Auto-Development Complete**\n\nA Pull Request has been created for this issue.\n\nPlease review the changes and provide feedback.`
            });
