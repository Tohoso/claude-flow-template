name: Daily Security Scan

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯Žæ—¥8:00 UTC
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼

env:
  NODE_VERSION: '18'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          npm install -g claude-flow@alpha
          npm ci --ignore-scripts || true

      - name: Run Security Analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npx claude-flow@alpha swarm "Analyze the codebase for security vulnerabilities, check dependencies for known CVEs, review authentication and authorization patterns, identify potential data leaks" \
            --agents "security-auditor,dependency-checker,code-reviewer" \
            --strategy parallel \
            --output-format json \
            --output-file /tmp/security-report.json \
            --non-interactive

      - name: Generate Report
        id: generate-report
        run: |
          node << 'EOF'
          const fs = require('fs');
          const date = new Date().toISOString().split('T')[0];
          
          let report;
          try {
            report = JSON.parse(fs.readFileSync('/tmp/security-report.json', 'utf8'));
          } catch (e) {
            report = { results: { errors: [], insights: [] }, summary: { totalAgents: 0, successRate: 1 } };
          }
          
          let markdown = `# Security Report - ${date}\n\n`;
          markdown += '## Summary\n\n';
          markdown += `- **Total Issues**: ${report.results?.errors?.length || 0}\n`;
          markdown += `- **Agents Used**: ${report.summary?.totalAgents || 'N/A'}\n`;
          markdown += `- **Success Rate**: ${((report.summary?.successRate || 1) * 100).toFixed(1)}%\n\n`;
          
          const errors = report.results?.errors || [];
          const insights = report.results?.insights || [];
          
          if (errors.length > 0) {
            markdown += '## ðŸš¨ Security Issues Found\n\n';
            errors.forEach((error, i) => {
              markdown += `${i + 1}. ${error}\n`;
            });
            markdown += '\n';
          } else {
            markdown += '## âœ… No Critical Security Issues\n\n';
          }
          
          if (insights.length > 0) {
            markdown += '## ðŸ’¡ Recommendations\n\n';
            insights.forEach((insight, i) => {
              markdown += `${i + 1}. ${insight}\n`;
            });
          }
          
          markdown += '\n---\n*Generated by [Claude Flow](https://github.com/ruvnet/claude-flow)*';
          
          fs.writeFileSync('/tmp/SECURITY_REPORT.md', markdown);
          
          // GitHub Actionsã®å‡ºåŠ›ã«å•é¡Œæ•°ã‚’è¨­å®š
          const issueCount = errors.length;
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `issue_count=${issueCount}\n`);
          EOF

      - name: Create Issue if Problems Found
        if: steps.generate-report.outputs.issue_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const markdown = fs.readFileSync('/tmp/SECURITY_REPORT.md', 'utf8');
            const issueCount = '${{ steps.generate-report.outputs.issue_count }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Alert: ${issueCount} issue(s) found`,
              body: markdown,
              labels: ['security', 'automated', 'high-priority']
            });

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_id }}
          path: /tmp/SECURITY_REPORT.md
